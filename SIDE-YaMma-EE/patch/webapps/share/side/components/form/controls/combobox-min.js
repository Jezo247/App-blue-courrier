if(typeof SIDE=="undefined"||!SIDE){var SIDE={}}if(console==undefined){var console={log:function(a){}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a}for(;c<a;c++){if(c in this&&this[c]===b){return c}}return -1}}(function(){var c=YAHOO.lang,i=YAHOO.util.Event,e=YAHOO.util.Dom;SIDE.ComboBox=function(k,l,j){SIDE.ComboBox.superclass.constructor.call(this,"SIDE.ComboBox",k,["button","menu","container","resize","datasource","datatable"]);this.htmlid=k;this.currentValueHtmlId=l;this.addedFieldHtmlId=k+"-added";this.removedFieldHtmlId=k+"-removed";this.DSSelectWidget=null;this.initialValue="";this.widgets.createNew=new SIDE.CreateTarget(this.htmlid,l);if(j){this.initialValue=j;console.log("field :"+k+" initialValue :"+j)}YAHOO.Bubbling.on("/side-labs/onCreateNewItem/"+this.currentValueHtmlId,this.reloadBehavior,this)};YAHOO.extend(SIDE.ComboBox,Alfresco.component.Base,{log:function(j){console.log("[SIDE.ComboBox] "+j)},options:{disabled:false,itemType:"",multipleSelectMode:false,mandatory:false,filterTerm:"*",advancedQuery:"",maxResults:-1,selectableTypeIsAspect:false,searchInSite:true,hideSelector:false,addNewConfig:{disabled:true,formconfig:{}},editConfig:{disabled:true,formconfig:{}},labelKey:"name"},setOptions:function(j){this.log("setOptions :"+j);SIDE.ComboBox.superclass.setOptions.call(this,j);if(j.getDataSource){this.options.getDataSource=j.getDataSource}else{var l=this;this.options.getDataSource=function k(n){var m=Alfresco.constants.PROXY_URI+"api/forms/picker/search/children?selectableType="+n.options.itemType+"&searchTerm="+n.options.filterTerm+"&size="+n.options.maxResults+"&advancedQuery="+n.options.advancedQuery+"&selectableTypeIsAspect="+n.options.selectableTypeIsAspect;if(n.options.searchInSite&&Alfresco.constants.SITE!=""&&Alfresco.constants.SITE!=undefined){m+="&site="+Alfresco.constants.SITE}if(n.options.startLocation){m+="&xpath="+YAHOO.lang.substitute(n.options.startLocation,n.options)}m=encodeURI(m);var o=new YAHOO.util.XHRDataSource(m);o.responseType=YAHOO.util.DataSource.TYPE_JSON;o.responseSchema={fields:["nodeRef","name","title"],resultsList:"data.items"};return o}}if(this.options.addNewConfig.formconfig.destination){this.options.addNewConfig.formconfig.destination=YAHOO.lang.substitute(this.options.addNewConfig.formconfig.destination,l.options)}this.widgets.createNew.setOptions(this.options.addNewConfig)},setMessages:function(j){SIDE.ComboBox.superclass.setMessages.call(this,j);this.widgets.createNew.setMessages(j);this.messages=j},createAddNewControl:function f(){var j=e.get(this.htmlid+"-actions");var k=document.createElement("button");j.appendChild(k);this.widgets.addButton=Alfresco.util.createYUIButton(this,null,this.onAddButtonClick,{label:this.options.selectActionLabel?this.options.selectActionLabel:this.msg("form.control.object-picker.add-item"),disabled:false},k)},onAddButtonClick:function(j,k){this.widgets.createNew.onNewItem(j,k)},load:function(){if(!this.options.disabled&&!this.options.addNewConfig.disabled){this.createAddNewControl()}var m=this.options.getDataSource(this);if(this.options.disabled){return new Alfresco.ObjectFinder(this.htmlid,this.currentValueHtmlId).setOptions({disabled:true,field:this.options.field,compactMode:true,currentValue:this.initialValue}).setMessages(this.messages)}else{if(this.options.multipleSelectMode){var j=new SIDE.MyDSMultiSelectField({name:"-",datasource:m,valueKey:"nodeRef",labelKey:this.options.labelKey,parentEl:this.htmlid,currentValueHtmlId:this.currentValueHtmlId,editConfig:this.options.editConfig},this.initialValue);j.setMessages(this.messages);var l=this;j.updatedEvt.subscribe(function(s,t){var n=t[0];var o=[];var q=[];var r=null;if(l.initialValue){r=l.initialValue.split(",")}if(r){for(var u=0;u<r.length;u++){var p=r[u];if(n.indexOf(p)==-1){q.push(p)}}for(var u=0;u<n.length;u++){var p=n[u];if(r.indexOf(p)==-1){o.push(p)}}}else{o=n}l.log("values changed to add :"+o.toString());l.log("values changed to remove :"+q.toString());YAHOO.util.Dom.get(l.addedFieldHtmlId).value=o.toString();YAHOO.util.Dom.get(l.removedFieldHtmlId).value=q.toString();YAHOO.util.Dom.get(l.currentValueHtmlId).value=n.toString();if(l.options.mandatory){YAHOO.Bubbling.fire("mandatoryControlValueUpdated",l)}});return j}else{var k=new SIDE.MyDSSelectField({name:"-",datasource:m,valueKey:"nodeRef",labelKey:this.options.labelKey,parentEl:this.htmlid,currentValueHtmlId:this.currentValueHtmlId,editConfig:this.options.editConfig},this.initialValue);var l=this;k.updatedEvt.subscribe(function(o,p){l.log("updatedEvt :"+o);l.log("state :"+p[1].previousState);var n=p[0];l.log("value :"+n);if(p[1].previousState=="valid"){l.log("value changed to :"+n.toString());l.log("initialValue :"+l.initialValue);if(n!=l.initialValue){l.log("value changed Add :"+n.toString());YAHOO.util.Dom.get(l.addedFieldHtmlId).value=n;if(l.initialValue!=""){l.log("value changed Remove :"+l.initialValue.toString());YAHOO.util.Dom.get(l.removedFieldHtmlId).value=l.initialValue}}else{l.log("cancel change ...");YAHOO.util.Dom.get(l.addedFieldHtmlId).value="";YAHOO.util.Dom.get(l.removedFieldHtmlId).value=""}}YAHOO.util.Dom.get(l.currentValueHtmlId).value=n.toString();if(k.editTarget){if(n!=""){k.editTarget.options.formconfig.itemId=n;k.widgets.editButton.set("disabled",false,false)}else{k.widgets.editButton.set("disabled",true,false)}}if(l.options.mandatory){YAHOO.Bubbling.fire("mandatoryControlValueUpdated",l)}});return k}}},onReady:function a(){YAHOO.Bubbling.fire("/side-labs/onReady/"+this.currentValueHtmlId,this);this.DSSelectWidget=this.load();if(this.options.hideSelector&&!this.options.disabled){this.DSSelectWidget.el.disabled=true;this.DSSelectWidget.el.style.display="none"}YAHOO.Bubbling.fire("/side-labs/onLoaded/"+this.currentValueHtmlId,this);if(this.options.mandatory&&!this.options.disabled){YAHOO.Bubbling.fire("mandatoryControlValueUpdated",this)}if(!this.options.disabled&&this.initialValue){this.setValue(this.initialValue)}YAHOO.Bubbling.fire("/side-labs/onInitialized/"+this.currentValueHtmlId,this);if(!this.options.disabled){var j=document.getElementById(this.currentValueHtmlId);j.widget=this}},setValue:function d(j){this.log("before setValue :"+this.getValue());this.DSSelectWidget.setValue(j);this.log("after setValue :"+this.getValue())},getValue:function d(){return this.DSSelectWidget.getValue()},reload:function g(k,j){this.log("mode :"+k+" addNodesToSelection :"+j);this.DSSelectWidget.reload(k,j)},reloadBehavior:function h(l,m,k){this.log("event :"+l);this.log("obj :"+m);this.log("scope :"+k);var j=m[1];this.log("obj[1] :"+j);this.reload(j.mode,j.values)},fireReload:function b(){YAHOO.Bubbling.fire("/side-labs/onCreateNewItem/"+this.currentValueHtmlId,{mode:"add",values:["workspace://SpacesStore/7eca31e0-7b33-4f73-b3d3-86e1d9e6fbb2"]})}})})();